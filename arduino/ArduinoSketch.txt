#include <EEPROM.h>
//******************************************************************************************************
volatile unsigned long micros_sp = 0;
volatile byte          sz        = 0;              //счетчик обнуления
volatile unsigned int  sp        = 0;              //скорость
volatile boolean       st        = false;          //триггер 
//******************************************************************************************************
volatile unsigned long micros_th = 0;
volatile byte          tz        = 0;              //счетчик обнуления
volatile unsigned int  th        = 0;              //обороты
volatile boolean       tt        = false;          //триггер 
//******************************************************************************************************
volatile unsigned long odometr   = 0;              //счетчик импульсов одометра
//******************************************************************************************************
         byte          sp_sens   = 6;              //количество имп./м датчика скорости
         unsigned int  sp_mult   = 0;              //коэфф. пересчета частоты в скорость
         unsigned int  od_mult   = 0;              //коэфф. пересчета импульсов в сотни метров
//******************************************************************************************************
int analogInput [4] = {0,0,0,0}; //массив аналоговых значений
int digitalInput[13] = {0,0,0,0,0,0,0,0,0,0,0,0,0}; //массив цифровых значений
String resultString = ""; //строка
int i; //счетчик циклов
//******************************************************************************************************

void setup() {
  Serial.begin(115200);  
  attachInterrupt(0, speedometr, RISING); //прерывание спидометра по фронтам импульса
                                          // SPEED  (M10-1 pin 4)
  attachInterrupt(1, tahometr, RISING);   //прерывание тахометра по фронтам импульса
                                          // RPM    (M10-1 pin 7)

  odometr = EEPROM_ulong_read(0);         //чтение счетчика импульсов и EEPROM
  sp_mult = 3600000 / sp_sens;            //вычисление коэфф. пересчета частоты в скорость
  od_mult = sp_sens * 100;                //вычисление коэфф. пересчета импульсов в сотни метров
}
//******************************************************************************************************

void loop() {
  // считываем аналоговые сигналы
  analogInput[0]   =      analogRead(0);         // напряжение БС   (M10-1 pin 3)
  analogInput[1]   =      analogRead(1);         // уровень топлива (M10-3 pin 1,7)
  analogInput[2]   =      analogRead(2);         // температура ОЖ  (M10-3 pin 8)
  analogInput[3]   =      analogRead(3);         // температура наружного воздуха

  //Считываем цифровые сигналы
  digitalInput[0] =       digitalRead(22);       //  OIL PRESSURE   (M10-1 pin 18)
  digitalInput[1] =       digitalRead(24);       //  CHECK ENGINE   (M10-1 pin 20)
  digitalInput[2] =       digitalRead(26);       //  CHARGE         (M10-1 pin 13)
  digitalInput[3] =       digitalRead(28);       //  BRAKE WARNING  (M10-2 pin 1)
  digitalInput[4] =       digitalRead(30);       //  ABS            (M10-1 pin 11)
  digitalInput[5] =       digitalRead(32);       //  IMMO           (M10-2 pin 16)
  digitalInput[6] =       digitalRead(34);       //  DOOR AJAR      (M10-1 pin 15)
  digitalInput[7] =       digitalRead(36);       //  TRUNK LID AJAR (M10-1 pin 16)
  digitalInput[8] =       digitalRead(38);       //  LEFT TURN      (M10-2 pin 11)
  digitalInput[9] =       digitalRead(40);       //  RIGHT TURN     (M10-2 pin 13)
  digitalInput[10] =      digitalRead(42);       //  HIGH BEAM      (M10-2 pin 9,10)
  digitalInput[11] =      digitalRead(44);       //  FRONT FOG      (M10-2 pin 12)
  digitalInput[12] =      digitalRead(46);       //  AIR BAG        (M10-2 pin 7,8)

  resultString = String(resultString + sp);
  resultString = String(resultString + ",");
  resultString = String(resultString + th);
  resultString = String(resultString + ",");
  resultString = String(resultString + odometr / od_mult);
  resultString = String(resultString + ",");

  for(i=0; i<=3; i++) {   // аналоговые данные
    resultString = String(resultString + analogInput[i]);
    resultString = String(resultString + ",");
  }

  for(i=0; i<=12; i++) {  // цифровые данные
    resultString = String(resultString  + digitalInput[i]);
    if (i!=12) resultString = String(resultString + ",");
  }
  resultString = String(resultString + "\n");
  
  Serial.print (resultString);
  resultString =  String("");
  tz = tz - 1;
  sz = sz - 1;
  if (tz == 0){th = 0;}
  if (sz == 0){sp = 0;}
  delay(500);
}

//******************************************************************************************************
void speedometr(){                                  //измеряем частоту на входе спидометра по прерыванию
  if(!st){micros_sp = micros();}
  else   {sp = (sp_mult/(micros() - micros_sp));}
  st = !st;
  sz = 30;
  odometr ++;
 }
//******************************************************************************************************
void tahometr(){                                    //измеряем частоту на входе тахометра по прерыванию
  if(!tt){micros_th = micros();}
  else   {th = (30000000/(micros() - micros_th));}
  tt = !tt;
  tz = 10;
}
// чтение двухбайтных переменных из EEPROM *************************************************************
unsigned long EEPROM_ulong_read(int addr) {   
  byte raw[4];
  for(byte i = 0; i < 4; i++) raw[i] = EEPROM.read(addr+i);
  unsigned long &num = (unsigned long&)raw;
  return num;
}
// запись двухбайтных переменных в EEPROM **************************************************************
void EEPROM_ulong_write(int addr, unsigned long num) {
  byte raw[4];
  (unsigned long&)raw = num;
  for(byte i = 0; i < 4; i++) EEPROM.write(addr+i, raw[i]);
}
//******************************************************************************************************